<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Multi-Section Markdown → HTML → MathJax (tex-svg)</title>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 2rem;
      line-height: 1.6;
      background: #f5f5f5;
    }
    h1 {
      margin-top: 0;
    }
    .section {
      max-width: 950px;
      margin-bottom: 2rem;
      padding: 1rem 1.25rem 1.5rem 1.25rem;
      background: #ffffff;
      border-radius: 8px;
      border: 1px solid #ddd;
      box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    }
    .section h2 {
      margin-top: 0;
    }
    .editor {
      width: 100%;
      height: 140px;
      padding: 0.75rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-family: "Fira Code", "Consolas", "SF Mono", monospace;
      box-sizing: border-box;
    }
    .render-btn {
      margin: 0.6rem 0 0.9rem 0;
      padding: 0.4rem 0.9rem;
      border-radius: 4px;
      border: 1px solid #888;
      background: #fff;
      cursor: pointer;
    }
    .render-btn:hover {
      background: #eee;
    }
    .output {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 0.75rem 1rem;
      min-height: 60px;
      background: #fafafa;
    }
    .error-msg {
      color: #b00020;
      font-size: 0.9rem;
      margin-top: 0.4rem;
    }
  </style>

  <!-- MathJax config: must come BEFORE tex-svg.js -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        packages: { '[+]': ['noerrors', 'noundefined'] }
      },
      svg: {
        fontCache: 'global'
      }
    };
  </script>

  <!-- Local MathJax component build -->
  <script src="./tex-svg.js"></script>
</head>
<body>
  <h1>Multi-Section Markdown → HTML → MathJax Demo</h1>
  <p>
    Each section below is rendered independently. You can deliberately introduce
    LaTeX errors in one section to see that the others continue to work.
  </p>

  <!-- Section 1 -->
  <div class="section" id="section-1">
    <h2>Section 1: Quadratic Formula</h2>
    <textarea class="editor" id="editor-1"></textarea><br>
    <button class="render-btn" data-target="1">Render Section 1</button>
    <div class="output mj-process" id="output-1"></div>
    <div class="error-msg" id="error-1"></div>
  </div>

  <!-- Section 2 -->
  <div class="section" id="section-2">
    <h2>Section 2: Trigonometric Identity</h2>
    <textarea class="editor" id="editor-2"></textarea><br>
    <button class="render-btn" data-target="2">Render Section 2</button>
    <div class="output mj-process" id="output-2"></div>
    <div class="error-msg" id="error-2"></div>
  </div>

  <!-- Section 3 -->
  <div class="section" id="section-3">
    <h2>Section 3: Play Area (Try Bad LaTeX Here)</h2>
    <textarea class="editor" id="editor-3"></textarea><br>
    <button class="render-btn" data-target="3">Render Section 3</button>
    <div class="output mj-process" id="output-3"></div>
    <div class="error-msg" id="error-3"></div>
  </div>

  <!-- Local helpers -->
  <script src="./marked.min.js"></script>
  <script src="./purify.min.js"></script>

  <script>
    // Initial content for each section (String.raw to preserve backslashes)
    const initial1 = String.raw`
Given a quadratic equation $$ax^2 + bx + c = 0$$ with $a \ne 0$,
the solutions are

$$x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}.$$
`;

    const initial2 = String.raw`
We have the Pythagorean identity

$$\sin^2 \theta + \cos^2 \theta = 1.$$

Inline example: $ \tan \theta = \frac{\sin \theta}{\cos \theta} $.
`;

    const initial3 = String.raw`
Try good or bad LaTeX here. For example, this is fine:

$$E = mc^2$$

Now intentionally break it (missing brace):

$$\frac{1}{1-x$$
`;

    const sections = [
      { id: 1, text: initial1 },
      { id: 2, text: initial2 },
      { id: 3, text: initial3 }
    ];

    function setInitialText() {
      sections.forEach(s => {
        document.getElementById(`editor-${s.id}`).value = s.text;
      });
    }

    async function renderSection(n) {
      const editor = document.getElementById(`editor-${n}`);
      const output = document.getElementById(`output-${n}`);
      const errorBox = document.getElementById(`error-${n}`);

      const markdown = editor.value;
      errorBox.textContent = "";

      // 1. Markdown → HTML
      const rawHtml = marked.parse(markdown, {
        mangle: false,
        headerIds: false,
        breaks: true
      });

      // 2. Sanitize
      const safeHtml = DOMPurify.sanitize(rawHtml);

      // 3. Inject into this section's output container
      output.innerHTML = safeHtml;

      // 4. Typeset ONLY this container with MathJax
      if (window.MathJax && MathJax.typesetPromise) {
        try {
          if (MathJax.typesetClear) {
            MathJax.typesetClear([output]);
          }
          await MathJax.typesetPromise([output]);
        } catch (err) {
          console.error(`MathJax error in section ${n}:`, err);
          errorBox.textContent = "MathJax error in this section (see console).";
          // Crucially, we do NOT rethrow: other sections are unaffected.
        }
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      // Wait for MathJax startup to complete
      if (window.MathJax && MathJax.startup && MathJax.startup.promise) {
        await MathJax.startup.promise;
      }

      setInitialText();

      // Wire each render button to its own section
      document.querySelectorAll(".render-btn").forEach(btn => {
        const target = btn.getAttribute("data-target");
        btn.addEventListener("click", () => {
          renderSection(target);
        });
      });

      // Initial render of all sections
      sections.forEach(s => renderSection(s.id));
    });
  </script>
</body>
</html>
